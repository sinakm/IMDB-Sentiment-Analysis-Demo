# Complete Deployment Guide: Sentiment Analysis with Frontend

This guide covers deploying the complete sentiment analysis application including both the backend API and React frontend to AWS.

## 🎯 What Gets Deployed

### Backend Infrastructure

- **AWS Lambda**: Containerized function with LSTM and Verbalizer models
- **API Gateway**: RESTful API with API key authentication
- **CloudWatch**: Monitoring, logging, and alarms
- **SNS**: Email notifications for alerts (optional)

### Frontend Infrastructure

- **S3 Bucket**: Static website hosting for React app
- **CloudFront**: Global CDN with caching and HTTPS
- **Origin Access Identity**: Secure S3 access
- **Cache Policies**: Optimized for Single Page Application

## 🚀 Quick Deployment

### Option 1: Automated Script (Recommended)

```bash
cd buildops/deployment/scripts
python deploy_with_frontend.py --environment prod --email your@email.com
```

### Option 2: Manual CDK Deployment

```bash
cd buildops/deployment/cdk

# Install dependencies
pip install -r requirements.txt

# Bootstrap CDK (first time only)
cdk bootstrap

# Deploy with frontend
cdk deploy --require-approval never -c environment=prod -c deploy_frontend=true
```

## 📋 Prerequisites

### Required Software

- **AWS CLI** v2.x configured with credentials
- **AWS CDK** v2.100+ (`npm install -g aws-cdk`)
- **Node.js** v18+ (v20+ recommended)
- **Python** 3.8+
- **Docker** (for Lambda container builds)

### AWS Permissions

Your AWS credentials need permissions for:

- Lambda (create, update, invoke)
- API Gateway (create, deploy, manage)
- S3 (create buckets, upload objects)
- CloudFront (create distributions)
- CloudWatch (create alarms, dashboards)
- IAM (create roles, policies)
- CloudFormation (create, update stacks)

### Verify Prerequisites

```bash
aws --version          # AWS CLI
cdk --version          # CDK
node --version         # Node.js
python --version       # Python
docker --version       # Docker
```

## 🔧 Configuration

### Environment Variables

The deployment automatically configures:

```bash
# Backend Environment
PYTHONPATH=/var/task
MODEL_PATH=/var/task/models
LOG_LEVEL=INFO
ENVIRONMENT=prod

# Frontend Environment (injected during build)
REACT_APP_API_URL=<auto-generated-api-url>
REACT_APP_API_KEY_ID=<auto-generated-key-id>
NODE_ENV=production
GENERATE_SOURCEMAP=false
```

### Deployment Environments

| Environment | Features                            | Use Case    |
| ----------- | ----------------------------------- | ----------- |
| `dev`       | Debug logs, no caching, auto-delete | Development |
| `staging`   | Production-like, with monitoring    | Testing     |
| `prod`      | Optimized, full monitoring, WAF     | Production  |

## 📁 Project Structure

```
buildops/
├── deployment/
│   ├── cdk/                    # CDK infrastructure code
│   │   ├── app.py             # CDK app entry point
│   │   ├── sentiment_stack.py # Main stack definition
│   │   ├── cdk_constructs/    # Reusable constructs
│   │   │   ├── lambda_construct.py
│   │   │   ├── api_gateway_construct.py
│   │   │   ├── frontend_construct.py
│   │   │   └── monitoring_construct.py
│   │   └── config/            # Configuration classes
│   ├── frontend/              # React application
│   │   ├── src/               # Source code
│   │   ├── public/            # Static assets
│   │   └── package.json       # Dependencies
│   ├── lambda/                # Lambda function code
│   │   ├── lambda_function.py # Main handler
│   │   ├── inference_engine.py # Model inference
│   │   └── models/            # Model artifacts
│   └── scripts/               # Deployment scripts
└── artifacts/                 # Trained model artifacts
```

## 🚀 Deployment Process

### Step 1: Prepare Models

Ensure model artifacts are in place:

```bash
# Check model artifacts
ls -la buildops/artifacts/lstm/
ls -la buildops/artifacts/verbalizer/

# Should contain:
# - config.json
# - model.pt (excluded from git)
# - vocab.json (for LSTM)
```

### Step 2: Deploy Infrastructure

```bash
cd buildops/deployment/scripts
python deploy_with_frontend.py --environment prod
```

The script will:

1. ✅ Check prerequisites
2. 📦 Install dependencies
3. 🚀 Bootstrap CDK
4. 🏗️ Deploy infrastructure
5. 📋 Display outputs

### Step 3: Verify Deployment

After deployment, you'll get outputs like:

```
ApiUrl: https://abc123.execute-api.us-east-1.amazonaws.com/prod
FrontendUrl: https://d1234567890.cloudfront.net
ApiKeyCommand: aws apigateway get-api-key --api-key xyz789 --include-value
```

### Step 4: Test the Application

1. **Get API Key**:

   ```bash
   aws apigateway get-api-key --api-key <key-id> --include-value --query 'value' --output text
   ```

2. **Test API Health**:

   ```bash
   curl https://your-api-url/health
   ```

3. **Test Sentiment Analysis**:

   ```bash
   curl -X POST https://your-api-url/predict \
     -H "Content-Type: application/json" \
     -H "x-api-key: YOUR_API_KEY" \
     -d '{"text": "This movie was amazing!", "model": "both"}'
   ```

4. **Access Frontend**:
   Open the CloudFront URL in your browser

## 🎯 Frontend Features

### User Interface

- **Material-UI Design**: Professional, responsive interface
- **Dual Model Support**: LSTM and Verbalizer with consensus
- **Interactive Gauges**: Visual confidence scores
- **Real-time Status**: API health monitoring
- **Form Validation**: Input validation and error handling

### Technical Features

- **TypeScript**: Type-safe development
- **React 18**: Modern React with hooks
- **Responsive Design**: Works on all devices
- **PWA Ready**: Progressive Web App capabilities
- **Error Boundaries**: Graceful error handling

## 📊 Monitoring & Observability

### CloudWatch Dashboards

- **API Metrics**: Request count, latency, errors
- **Lambda Metrics**: Duration, memory usage, errors
- **Frontend Metrics**: CloudFront requests, cache hit ratio

### Alarms

- **High Error Rate**: >5% error rate for 5 minutes
- **High Latency**: >10s response time
- **Lambda Failures**: Function errors

### Logs

- **API Gateway**: Request/response logs
- **Lambda**: Application logs with structured logging
- **CloudFront**: Access logs (optional)

## 🔒 Security Features

### API Security

- **API Key Authentication**: Required for all requests
- **CORS Configuration**: Controlled cross-origin access
- **Rate Limiting**: Throttling and quotas
- **Input Validation**: Request validation

### Frontend Security

- **HTTPS Enforcement**: All traffic over HTTPS
- **Security Headers**: XSS protection, content security
- **Private S3**: No direct public access
- **Origin Access Identity**: CloudFront-only access

## 🛠️ Troubleshooting

### Common Issues

1. **CDK Bootstrap Required**

   ```bash
   cdk bootstrap
   ```

2. **Node.js Version Warning**

   - Upgrade to Node.js 20+ for best compatibility
   - Current deployment works with Node.js 18+

3. **Model Artifacts Missing**

   ```bash
   # Train models first
   python train_lstm_only.py
   python train_verbalizer_only.py
   ```

4. **AWS Credentials**

   ```bash
   aws configure
   # or
   export AWS_ACCESS_KEY_ID=...
   export AWS_SECRET_ACCESS_KEY=...
   ```

5. **Frontend Build Failures**
   ```bash
   cd deployment/frontend
   rm -rf node_modules package-lock.json
   npm install
   ```

### Debug Commands

```bash
# Check CDK diff
cdk diff

# Validate CDK template
cdk synth

# Check CloudFormation events
aws cloudformation describe-stack-events --stack-name SentimentAnalysisStack-prod

# Check Lambda logs
aws logs tail /aws/lambda/sentiment-analysis-prod --follow

# Test API directly
aws lambda invoke --function-name sentiment-analysis-prod \
  --payload '{"body": "{\"text\":\"test\",\"model\":\"both\"}"}' \
  response.json
```

## 💰 Cost Optimization

### Estimated Monthly Costs (us-east-1)

| Service     | Usage                  | Cost          |
| ----------- | ---------------------- | ------------- |
| Lambda      | 10K requests/month     | $0.20         |
| API Gateway | 10K requests/month     | $0.35         |
| S3          | 1GB storage + requests | $0.25         |
| CloudFront  | 1GB transfer           | $0.085        |
| CloudWatch  | Basic monitoring       | $3.00         |
| **Total**   |                        | **~$4/month** |

### Cost Optimization Tips

- Use CloudFront caching to reduce API calls
- Set up S3 lifecycle policies for old versions
- Monitor CloudWatch costs and adjust retention
- Use reserved capacity for high-traffic scenarios

## 🔄 Updates & Maintenance

### Updating Models

1. Train new models
2. Update artifacts in `buildops/artifacts/`
3. Redeploy: `cdk deploy`

### Updating Frontend

1. Make changes in `deployment/frontend/src/`
2. Redeploy: `cdk deploy`
3. CloudFront cache automatically invalidated

### Updating Infrastructure

1. Modify CDK code in `deployment/cdk/`
2. Test: `cdk diff`
3. Deploy: `cdk deploy`

## 🗑️ Cleanup

### Remove Everything

```bash
cd buildops/deployment/cdk
cdk destroy
```

### Remove Specific Components

```bash
# Remove only frontend
cdk deploy -c deploy_frontend=false

# Remove monitoring
cdk deploy -c enable_monitoring=false
```

## 📞 Support

### Getting Help

1. Check CloudWatch logs for errors
2. Review CDK documentation
3. Check AWS service limits
4. Verify IAM permissions

### Useful Resources

- [AWS CDK Documentation](https://docs.aws.amazon.com/cdk/)
- [React Documentation](https://react.dev/)
- [Material-UI Documentation](https://mui.com/)
- [AWS Lambda Best Practices](https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html)

## 🎉 Success!

After successful deployment, you'll have:

- ✅ Production-ready sentiment analysis API
- ✅ Beautiful React frontend with real-time analysis
- ✅ Global CDN for fast performance
- ✅ Comprehensive monitoring and alerting
- ✅ Secure, scalable infrastructure

Your sentiment analysis application is now live and ready for users! 🚀
